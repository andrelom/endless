<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Navigating the Personalization Landscape: A Case for Next.js Static Site Generation with Sitecore XM Cloud | André Moraes</title>
<meta name=keywords content="Sitecore,Sitecore XM Cloud,Personalization,Static Site Generation,Next.js"><meta name=description content="Explore the power of Next.js Static Site Generation in a integration with Sitecore XM Cloud. Uncover the benefits of personalized user experiences while overcoming the challenges of server-side rendering."><meta name=author content="André Moraes"><link rel=canonical href=https://andrelom.github.io/endless/posts/personalization-case-nextjs-static-site-generation-sitecore-xm-cloud/><link crossorigin=anonymous href=/endless/assets/css/stylesheet.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/endless/assets/js/highlight.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://andrelom.github.io/endless/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andrelom.github.io/endless/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andrelom.github.io/endless/favicon-32x32.png><link rel=apple-touch-icon href=https://andrelom.github.io/endless/apple-touch-icon.png><link rel=mask-icon href=https://andrelom.github.io/endless/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Navigating the Personalization Landscape: A Case for Next.js Static Site Generation with Sitecore XM Cloud"><meta property="og:description" content="Explore the power of Next.js Static Site Generation in a integration with Sitecore XM Cloud. Uncover the benefits of personalized user experiences while overcoming the challenges of server-side rendering."><meta property="og:type" content="article"><meta property="og:url" content="https://andrelom.github.io/endless/posts/personalization-case-nextjs-static-site-generation-sitecore-xm-cloud/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-11-29T04:25:32-03:00"><meta property="article:modified_time" content="2023-11-29T04:25:32-03:00"><meta property="og:site_name" content="Endless"><meta name=twitter:card content="summary"><meta name=twitter:title content="Navigating the Personalization Landscape: A Case for Next.js Static Site Generation with Sitecore XM Cloud"><meta name=twitter:description content="Explore the power of Next.js Static Site Generation in a integration with Sitecore XM Cloud. Uncover the benefits of personalized user experiences while overcoming the challenges of server-side rendering."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://andrelom.github.io/endless/posts/"},{"@type":"ListItem","position":2,"name":"Navigating the Personalization Landscape: A Case for Next.js Static Site Generation with Sitecore XM Cloud","item":"https://andrelom.github.io/endless/posts/personalization-case-nextjs-static-site-generation-sitecore-xm-cloud/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Navigating the Personalization Landscape: A Case for Next.js Static Site Generation with Sitecore XM Cloud","name":"Navigating the Personalization Landscape: A Case for Next.js Static Site Generation with Sitecore XM Cloud","description":"Explore the power of Next.js Static Site Generation in a integration with Sitecore XM Cloud. Uncover the benefits of personalized user experiences while overcoming the challenges of server-side rendering.","keywords":["Sitecore","Sitecore XM Cloud","Personalization","Static Site Generation","Next.js"],"articleBody":"In a recent webinar, I dived deep into the seamless integration of Sitecore XM Cloud and Next.js Static Site Generation (SSG) to not only unlock efficient and personalized user experiences but also mitigate the downsides associated with server-side rendering. This blog post distills the key insights from the webinar, shedding light on the benefits of SSG and the pitfalls of relying solely on server-side rendering, especially in scenarios involving Sitecore XM Cloud’s Connected and Disconnected modes.\nThe Pitfalls of Server-Side Rendering In many applications dealing with Sitecore XM Cloud, the need for Connected and Disconnected modes is a common reality. In Disconnected mode, numerous GraphQL calls to each component, along with integrations with various vendors, may result in a significant overhead. The traditional server-side rendering approach necessitates repeating all these requests on every page request, leading to resource-intensive operations and potentially hindering overall performance.\nThe Power of Internal URL Rewriting To address these challenges, the webinar emphasized the innovative approach of internal URL rewriting within the Next.js middleware. By leveraging this technique, teams can achieve Static Site Generation (SSG) and still deliver unique and personalized output for each user, without the resource-intensive nature of server-side rendering.\nFile System Structure Evolution A significant structural change in the file system route enhances this approach. The root file, previously located at “src\\pages[[…path]].tsx,” has been strategically relocated to “\\src\\pages[country][username][[…path]].tsx.” This shift optimizes the organization of dynamic content and supports the personalization goals of individual user sessions.\nExample Code Revisited: import type { NextRequest, NextFetchEvent } from 'next/server' import { NextResponse } from 'next/server' import middleware from 'lib/middleware' const isHTMLDocument = (req: NextRequest): boolean =\u003e { return req.headers.get('accept')?.toLowerCase().includes('text/html') ?? false } export const rewrite = (req: NextRequest) =\u003e { const url = req.nextUrl.clone() const cookie = req.cookies.get('next.session.user') const country = req.geo?.country?.toLowerCase() ?? 'global' const username = cookie?.value ?? 'anonymous' let pathname = '' pathname += `/${country}` pathname += `/${username}` pathname += `/${url.pathname}` url.pathname = pathname.replace(/\\/+/gi, '/') // Enable per-session caching for \"getStaticProps\". return NextResponse.rewrite(url) } export const config = { matcher: ['/', '/((?!api/|_next/|sitecore/api/|-/|healthz).*)'], } export default async function handler(req: NextRequest, event: NextFetchEvent) { const res = await middleware(req, event) if (isHTMLDocument(req)) { return rewrite(req) } return res } The Advantages of Next.js SSG: Resource-Efficiency: By transitioning to Next.js SSG, teams can significantly reduce resource consumption, especially in scenarios involving Connected and Disconnected modes in Sitecore XM Cloud.\nPersonalization without Overhead: Achieve personalized output for each user session without the need for repeated GraphQL calls and integrations on every page request, optimizing both performance and user experience.\nClosing Thoughts While personalization is a crucial aspect of modern web applications, the webinar emphasized the need to carefully consider the downsides of server-side rendering, especially in resource-intensive scenarios. The innovative use of internal URL rewriting within the Next.js middleware emerges as a robust solution, enabling Static Site Generation and personalized content delivery without compromising performance.\nFor a more in-depth example to explore the implementation, please refer to the source code available in this Github repository.\n","wordCount":"497","inLanguage":"en","datePublished":"2023-11-29T04:25:32-03:00","dateModified":"2023-11-29T04:25:32-03:00","author":{"@type":"Person","name":"André Moraes"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://andrelom.github.io/endless/posts/personalization-case-nextjs-static-site-generation-sitecore-xm-cloud/"},"publisher":{"@type":"Organization","name":"André Moraes","logo":{"@type":"ImageObject","url":"https://andrelom.github.io/endless/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andrelom.github.io/endless/ accesskey=h title="André Moraes (Alt + H)">André Moraes</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://andrelom.github.io/endless/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://andrelom.github.io/endless/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://andrelom.github.io/endless/archives/ title=Archives><span>Archives</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Navigating the Personalization Landscape: A Case for Next.js Static Site Generation with Sitecore XM Cloud</h1><div class=post-description>Explore the power of Next.js Static Site Generation in a integration with Sitecore XM Cloud. Uncover the benefits of personalized user experiences while overcoming the challenges of server-side rendering.</div><div class=post-meta>November 29, 2023</div></header><div class=post-content><p>In a recent webinar, I dived deep into the seamless integration of Sitecore XM Cloud and Next.js Static Site Generation (SSG) to not only unlock efficient and personalized user experiences but also mitigate the downsides associated with server-side rendering. This blog post distills the key insights from the webinar, shedding light on the benefits of SSG and the pitfalls of relying solely on server-side rendering, especially in scenarios involving Sitecore XM Cloud&rsquo;s Connected and Disconnected modes.</p><h3 id=the-pitfalls-of-server-side-rendering>The Pitfalls of Server-Side Rendering<a hidden class=anchor aria-hidden=true href=#the-pitfalls-of-server-side-rendering>#</a></h3><p>In many applications dealing with Sitecore XM Cloud, the need for Connected and Disconnected modes is a common reality. In Disconnected mode, numerous GraphQL calls to each component, along with integrations with various vendors, may result in a significant overhead. The traditional server-side rendering approach necessitates repeating all these requests on every page request, leading to resource-intensive operations and potentially hindering overall performance.</p><h3 id=the-power-of-internal-url-rewriting>The Power of Internal URL Rewriting<a hidden class=anchor aria-hidden=true href=#the-power-of-internal-url-rewriting>#</a></h3><p>To address these challenges, the webinar emphasized the innovative approach of internal URL rewriting within the Next.js middleware. By leveraging this technique, teams can achieve Static Site Generation (SSG) and still deliver unique and personalized output for each user, without the resource-intensive nature of server-side rendering.</p><h3 id=file-system-structure-evolution>File System Structure Evolution<a hidden class=anchor aria-hidden=true href=#file-system-structure-evolution>#</a></h3><p>A significant structural change in the file system route enhances this approach. The root file, previously located at &ldquo;src\pages[[&mldr;path]].tsx,&rdquo; has been strategically relocated to &ldquo;\src\pages[country][username][[&mldr;path]].tsx.&rdquo; This shift optimizes the organization of dynamic content and supports the personalization goals of individual user sessions.</p><h3 id=example-code-revisited>Example Code Revisited:<a hidden class=anchor aria-hidden=true href=#example-code-revisited>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#66d9ef>type</span> { <span style=color:#a6e22e>NextRequest</span>, <span style=color:#a6e22e>NextFetchEvent</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;next/server&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>NextResponse</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;next/server&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>middleware</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;lib/middleware&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>isHTMLDocument</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>req</span>: <span style=color:#66d9ef>NextRequest</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>boolean</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>headers</span>.<span style=color:#66d9ef>get</span>(<span style=color:#e6db74>&#39;accept&#39;</span>)<span style=color:#f92672>?</span>.<span style=color:#a6e22e>toLowerCase</span>().<span style=color:#a6e22e>includes</span>(<span style=color:#e6db74>&#39;text/html&#39;</span>) <span style=color:#f92672>??</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>rewrite</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>req</span>: <span style=color:#66d9ef>NextRequest</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>url</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>nextUrl</span>.<span style=color:#a6e22e>clone</span>()
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cookie</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>cookies</span>.<span style=color:#66d9ef>get</span>(<span style=color:#e6db74>&#39;next.session.user&#39;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>country</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>geo</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>country</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>toLowerCase</span>() <span style=color:#f92672>??</span> <span style=color:#e6db74>&#39;global&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>username</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>cookie</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>value</span> <span style=color:#f92672>??</span> <span style=color:#e6db74>&#39;anonymous&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>pathname</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>pathname</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>country</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>pathname</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>username</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>pathname</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>pathname</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>pathname</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pathname</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>/\/+/gi</span>, <span style=color:#e6db74>&#39;/&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Enable per-session caching for &#34;getStaticProps&#34;.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>NextResponse</span>.<span style=color:#a6e22e>rewrite</span>(<span style=color:#a6e22e>url</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>matcher</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;/&#39;</span>, <span style=color:#e6db74>&#39;/((?!api/|_next/|sitecore/api/|-/|healthz).*)&#39;</span>],
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handler</span>(<span style=color:#a6e22e>req</span>: <span style=color:#66d9ef>NextRequest</span>, <span style=color:#a6e22e>event</span>: <span style=color:#66d9ef>NextFetchEvent</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>res</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>middleware</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>event</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isHTMLDocument</span>(<span style=color:#a6e22e>req</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rewrite</span>(<span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=the-advantages-of-nextjs-ssg>The Advantages of Next.js SSG:<a hidden class=anchor aria-hidden=true href=#the-advantages-of-nextjs-ssg>#</a></h3><ol><li><p><strong>Resource-Efficiency:</strong> By transitioning to Next.js SSG, teams can significantly reduce resource consumption, especially in scenarios involving Connected and Disconnected modes in Sitecore XM Cloud.</p></li><li><p><strong>Personalization without Overhead:</strong> Achieve personalized output for each user session without the need for repeated GraphQL calls and integrations on every page request, optimizing both performance and user experience.</p></li></ol><h3 id=closing-thoughts>Closing Thoughts<a hidden class=anchor aria-hidden=true href=#closing-thoughts>#</a></h3><p>While personalization is a crucial aspect of modern web applications, the webinar emphasized the need to carefully consider the downsides of server-side rendering, especially in resource-intensive scenarios. The innovative use of internal URL rewriting within the Next.js middleware emerges as a robust solution, enabling Static Site Generation and personalized content delivery without compromising performance.</p><p>For a more in-depth example to explore the implementation, please refer to the source code available in <a href=https://github.com/andrelom/xmcloud-demo>this Github repository</a>.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andrelom.github.io/endless/tags/sitecore/>Sitecore</a></li><li><a href=https://andrelom.github.io/endless/tags/sitecore-xm-cloud/>Sitecore XM Cloud</a></li><li><a href=https://andrelom.github.io/endless/tags/personalization/>Personalization</a></li><li><a href=https://andrelom.github.io/endless/tags/static-site-generation/>Static Site Generation</a></li><li><a href=https://andrelom.github.io/endless/tags/next.js/>Next.js</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://andrelom.github.io/endless/>André Moraes</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>